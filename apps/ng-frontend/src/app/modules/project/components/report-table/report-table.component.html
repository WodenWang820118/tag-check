<div class="report-table mat-elevation-z0">
  <!-- Legend and Status Filter -->
  <div class="report-table__header">
    <div class="legend" aria-label="status legend">
      <mat-icon class="true-status" inline>check_circle</mat-icon>
      <span>Passed</span>
      <mat-icon class="false-status" inline>cancel</mat-icon>
      <span>Failed</span>
      <mat-icon class="pending-status" inline>hourglass_empty</mat-icon>
      <span>Not run</span>
    </div>
    <div class="filters" aria-label="status filter">
      <button
        mat-stroked-button
        [color]="statusFilter === 'all' ? 'primary' : null"
        (click)="setStatusFilter('all')"
      >
        All
      </button>
      <button
        mat-stroked-button
        [color]="statusFilter === 'notRun' ? 'primary' : null"
        (click)="setStatusFilter('notRun')"
      >
        Not run
      </button>
      <button
        mat-stroked-button
        [color]="statusFilter === 'failed' ? 'primary' : null"
        (click)="setStatusFilter('failed')"
      >
        Failed
      </button>
      <button
        mat-stroked-button
        [color]="statusFilter === 'partial' ? 'primary' : null"
        (click)="setStatusFilter('partial')"
      >
        Partial
      </button>
      <button
        mat-stroked-button
        [color]="statusFilter === 'passed' ? 'primary' : null"
        (click)="setStatusFilter('passed')"
      >
        Passed
      </button>
    </div>
  </div>
  <table
    mat-table
    [dataSource]="dataSource"
    multiTemplateDataRows
    matSort
    (matSortChange)="sortData($event)"
    #reportTable
    class="w-full"
  >
    <!-- Reusable tri-state status icon (Passed / Failed / Not run) -->
    <ng-template
      #triStateIcon
      let-value="value"
      let-updatedAt="updatedAt"
      let-createdAt="createdAt"
      let-label="label"
      let-tooltipDisabled="tooltipDisabled"
    >
      <mat-icon
        [ngClass]="{
          'true-status': value === true && updatedAt > createdAt,
          'false-status': value === false && updatedAt > createdAt,
          'pending-status': updatedAt <= createdAt
        }"
        [matTooltip]="
          (label || 'Status') +
          ': ' +
          (updatedAt > createdAt
            ? value
              ? 'Passed'
              : 'Failed'
            : 'Not run yet')
        "
        [matTooltipDisabled]="!!tooltipDisabled"
        [attr.aria-label]="
          (label || 'status') +
          ' ' +
          (updatedAt > createdAt
            ? value
              ? 'passed'
              : 'failed'
            : 'not run yet')
        "
      >
        @if (updatedAt > createdAt) {
          {{ value ? 'check_circle' : 'cancel' }}
        } @else {
          hourglass_empty
        }
      </mat-icon>
    </ng-template>
    <ng-container matColumnDef="select">
      <th mat-header-cell *matHeaderCellDef>
        <mat-checkbox
          (change)="toggleAllRows()"
          [checked]="isAllSelected"
          [indeterminate]="selection.hasValue() && !isAllSelected"
          [aria-label]="checkboxLabel()"
          [disabled]="testRunningFacadeService.isRunningTest$()"
        >
        </mat-checkbox>
      </th>
      <td mat-cell *matCellDef="let row">
        <mat-checkbox
          (click)="$event.stopPropagation()"
          (change)="toggleSelection(row)"
          (keydown)="$event.key === 'Enter' && toggleSelection(row)"
          [checked]="selection.isSelected(row)"
          [aria-label]="checkboxLabel(row)"
          [disabled]="testRunningFacadeService.isRunningTest$()"
        >
        </mat-checkbox>
      </td>
    </ng-container>
    <ng-container matColumnDef="testName">
      <th mat-header-cell mat-sort-header *matHeaderCellDef>Test Name</th>
      <td mat-cell *matCellDef="let element">
        <a
          style="text-decoration: none"
          [routerLink]="['./', element.eventId]"
          matBadge="bookmark_border"
          [matBadgeHidden]="!element.stopNavigation"
          matBadgeOverlap="false"
        >
          {{ element.testName }}
        </a>
      </td>
    </ng-container>
    <ng-container matColumnDef="eventName">
      <th mat-header-cell mat-sort-header *matHeaderCellDef>Event</th>
      <td mat-cell *matCellDef="let element">
        {{ element.eventName }}
      </td>
    </ng-container>

    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef>Status</th>
      <td mat-cell *matCellDef="let element">
        @if (element.updatedAt > element.createdAt) {
          <div class="status-icons" aria-label="Status: data layer and request">
            <mat-chip-set aria-label="Status chips">
              <mat-chip
                [color]="element.passed ? 'primary' : 'warn'"
                [matTooltip]="
                  element.passed ? 'Data layer: Passed' : 'Data layer: Failed'
                "
                selected
              >
                <div class="flex items-center gap-1">
                  <ng-container
                    [ngTemplateOutlet]="triStateIcon"
                    [ngTemplateOutletContext]="{
                      value: element.passed,
                      updatedAt: element.updatedAt,
                      createdAt: element.createdAt,
                      label: 'Data layer',
                      tooltipDisabled: true
                    }"
                  ></ng-container>
                  <span class="ml-1">Data layer</span>
                </div>
              </mat-chip>
              <mat-chip
                [color]="element.requestPassed ? 'primary' : 'warn'"
                [matTooltip]="
                  element.requestPassed ? 'Request: Passed' : 'Request: Failed'
                "
                selected
              >
                <div class="flex items-center gap-1">
                  <ng-container
                    [ngTemplateOutlet]="triStateIcon"
                    [ngTemplateOutletContext]="{
                      value: element.requestPassed,
                      updatedAt: element.updatedAt,
                      createdAt: element.createdAt,
                      label: 'Request',
                      tooltipDisabled: true
                    }"
                  ></ng-container>
                  <span class="ml-1">Request</span>
                </div>
              </mat-chip>
            </mat-chip-set>
          </div>
        } @else {
          <div class="status-icons" aria-label="Status: not run yet">
            <mat-chip-set aria-label="Status chips">
              <mat-chip
                [color]="'accent'"
                [matTooltip]="'Status: Not run yet'"
                selected
              >
                <div class="flex items-center gap-1">
                  <ng-container
                    [ngTemplateOutlet]="triStateIcon"
                    [ngTemplateOutletContext]="{
                      value: null,
                      updatedAt: element.updatedAt,
                      createdAt: element.createdAt,
                      label: 'Status',
                      tooltipDisabled: true
                    }"
                  ></ng-container>
                  <span class="ml-1">Not run</span>
                </div>
              </mat-chip>
            </mat-chip-set>
          </div>
        }
      </td>
    </ng-container>

    <ng-container matColumnDef="completedTime">
      <th mat-header-cell mat-sort-header *matHeaderCellDef>Last QA Time</th>
      <td mat-cell *matCellDef="let element">
        @if (element.updatedAt > element.createdAt) {
          {{ element.updatedAt | date: 'medium' }}
        } @else {
          <span class="muted" matTooltip="Not run yet">â€”</span>
        }
      </td>
    </ng-container>

    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef aria-label="row actions">
        Actions
      </th>
      <td mat-cell *matCellDef="let element">
        <!-- running a test -->
        @if (testRunningFacadeService.isRunningTest$()) {
          @if (
            testRunningFacadeService.eventRunningTest$() === element.eventId
          ) {
            <div style="padding-left: 10px">
              <app-progress-pie-chart></app-progress-pie-chart>
            </div>
          } @else if (
            testRunningFacadeService.eventRunningTest$() !== element.eventId
          ) {
            <!-- other buttons should be disabled when running a test -->
            <button
              mat-icon-button
              aria-label="run test"
              (click)="runTest(element.eventId); $event.stopPropagation()"
              [disabled]="true"
            >
              <mat-icon>play_arrow</mat-icon>
            </button>
            <!-- else, show the display button by default; if there's no recording, use another icon to prompt user -->
          }
        } @else {
          @if (element.hasRecording) {
            <button
              mat-icon-button
              aria-label="run test"
              (click)="runTest(element.eventId); $event.stopPropagation()"
            >
              <mat-icon>play_arrow</mat-icon>
            </button>
          } @else {
            <button
              mat-icon-button
              aria-label="add recording"
              [routerLink]="['./', element.eventId]"
              [queryParams]="{ tab: 'reports', snackbar: 'missingRecording' }"
              matTooltipPosition="above"
              matTooltip="Please add recording to run test"
            >
              <mat-icon>report_problem</mat-icon>
            </button>
          }
        }
      </td>
    </ng-container>

    <tr
      mat-header-row
      *matHeaderRowDef="columnsWithExpand"
      class="bg-gray-50/60 dark:bg-slate-800/60"
    ></tr>
    <tr
      mat-row
      *matRowDef="let element; columns: columnsWithExpand"
      class="element-row"
    ></tr>
  </table>
  <mat-paginator
    [pageSizeOptions]="[7, 10, 25, 100]"
    aria-label="Select page of tests"
  ></mat-paginator>
</div>
